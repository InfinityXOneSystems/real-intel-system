param([Parameter(Mandatory)][string]$ROOT)
$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

function Import-Maybe([string]$Path) {   if (Test-Path $Path) { Import-Module $Path -Force; return $true }   return $false }

$scfOk = Import-Maybe (Join-Path $ROOT "system\governor\scf.psm1")
$ucgOk = Import-Maybe (Join-Path $ROOT "system\meta\ucg\ucg.psm1")

if ($scfOk -and (Get-Command Assert-ScfRunAllowed -ErrorAction SilentlyContinue)) {
  Assert-ScfRunAllowed -ROOT $ROOT -Subsystem "evolution"
}
if ($ucgOk -and (Get-Command Initialize-Ucg -ErrorAction SilentlyContinue)) {
  Initialize-Ucg -ROOT $ROOT
}

$run = $null
if ($ucgOk -and (Get-Command Start-UcgRun -ErrorAction SilentlyContinue)) {
  $run = Start-UcgRun -ROOT $ROOT -Subsystem "evolution" -Script $PSCommandPath
}

try {
  Write-Host "ðŸŒ± Omega Evolution â€” Tick (clean)" -ForegroundColor Yellow
  $log = Join-Path $ROOT "system\evolution\evolution_log.txt"
  ("Tick: " + (Get-Date).ToString("o")) | Out-File -FilePath $log -Append -Encoding utf8
  if ($ucgOk -and (Get-Command Write-UcgEvent -ErrorAction SilentlyContinue)) {
    Write-UcgEvent -ROOT $ROOT -Type "evolution.tick" -Data @{ status="ok"; log_path=$log }
  }
  if ($ucgOk -and $run -and (Get-Command Stop-UcgRun -ErrorAction SilentlyContinue)) {
    Stop-UcgRun -ROOT $ROOT -RunId $run -Status "ok"
  }
  Write-Host "âœ” Evolution OK" -ForegroundColor Green
} catch {
  $err = $_.Exception.Message
  if ($ucgOk -and (Get-Command Write-UcgEvent -ErrorAction SilentlyContinue)) {
    Write-UcgEvent -ROOT $ROOT -Type "evolution.tick" -Data @{ status="error"; error=$err }
  }
  if ($ucgOk -and $run -and (Get-Command Stop-UcgRun -ErrorAction SilentlyContinue)) {
    Stop-UcgRun -ROOT $ROOT -RunId $run -Status "error" -Error $err
  }
  throw
}