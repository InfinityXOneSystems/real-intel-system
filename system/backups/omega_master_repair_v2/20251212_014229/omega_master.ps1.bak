param(
  [Parameter(Mandatory)][string]$ROOT
)

$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

function Try-ImportModule {
  param([Parameter(Mandatory)][string]$Path)
  if (Test-Path $Path) {
    Import-Module $Path -Force
    return $true
  }
  return $false
}

$scfOk = Try-ImportModule -Path (Join-Path $ROOT "system\governor\scf.psm1")
$ucgOk = Try-ImportModule -Path (Join-Path $ROOT "system\meta\ucg\ucg.psm1")

if ($scfOk -and (Get-Command Assert-ScfRunAllowed -ErrorAction SilentlyContinue)) {
  Assert-ScfRunAllowed -ROOT $ROOT -Subsystem "omega.master"
}
if ($ucgOk -and (Get-Command Initialize-Ucg -ErrorAction SilentlyContinue)) {
  Initialize-Ucg -ROOT $ROOT
}

Write-Host ""
Write-Host "ðŸ”¥ OMEGA MASTER â€” BOOT (clean)" -ForegroundColor Magenta

$globalRun = $null
if ($ucgOk -and (Get-Command Start-UcgRun -ErrorAction SilentlyContinue)) {
  $globalRun = Start-UcgRun -ROOT $ROOT -Subsystem "omega.master" -Script $PSCommandPath
}

function Invoke-Step {
  param(
    [Parameter(Mandatory)][string]$Name,
    [Parameter(Mandatory)][string]$ScriptPath
  )

  if (-not (Test-Path $ScriptPath)) {
    Write-Host "âš  SKIP: $Name (missing: $ScriptPath)" -ForegroundColor Yellow
    if ($ucgOk -and (Get-Command Write-UcgEvent -ErrorAction SilentlyContinue)) {
      Write-UcgEvent -ROOT $ROOT -Type "step.skipped" -Data @{ name=$Name; path=$ScriptPath }
    }
    return
  }

  Write-Host "âš™ $Name" -ForegroundColor Cyan

  $stepRun = $null
  if ($ucgOk -and (Get-Command Start-UcgRun -ErrorAction SilentlyContinue)) {
    $stepRun = Start-UcgRun -ROOT $ROOT -Subsystem ("step:" + $Name) -Script $ScriptPath
  }

  try {
    & $ScriptPath -ROOT $ROOT
    if ($ucgOk -and $stepRun -and (Get-Command Stop-UcgRun -ErrorAction SilentlyContinue)) {
      Stop-UcgRun -ROOT $ROOT -RunId $stepRun -Status "ok"
    }
    Write-Host "âœ” DONE: $Name" -ForegroundColor Green
  }
  catch {
    if ($ucgOk -and $stepRun -and (Get-Command Stop-UcgRun -ErrorAction SilentlyContinue)) {
      Stop-UcgRun -ROOT $ROOT -RunId $stepRun -Status "error" -Error $_.Exception.Message
    }
    Write-Host "âŒ FAIL: $Name => $($_.Exception.Message)" -ForegroundColor Red
    throw
  }
}

try {
  Invoke-Step -Name "Omega Kernel"         -ScriptPath (Join-Path $ROOT "system\kernel\omega_kernel.ps1")
  Invoke-Step -Name "Omega Builder"        -ScriptPath (Join-Path $ROOT "system\builder\omega_builder.ps1")
  Invoke-Step -Name "Omega Upgrade"        -ScriptPath (Join-Path $ROOT "system\upgrade\omega_upgrade.ps1")
  Invoke-Step -Name "Omega Mapper"         -ScriptPath (Join-Path $ROOT "system\map\omega_map.ps1")
  Invoke-Step -Name "Omega Evolve"         -ScriptPath (Join-Path $ROOT "system\evolution\omega_evolve.ps1")
  Invoke-Step -Name "Ingestion Discover"   -ScriptPath (Join-Path $ROOT "ingestion\discovery\discover.ps1")
  Invoke-Step -Name "Agent Market Tick"    -ScriptPath (Join-Path $ROOT "agents\market\market_tick.ps1")
  Invoke-Step -Name "Repo Sync Engine"     -ScriptPath (Join-Path $ROOT "system\sync\repo_sync_engine.ps1")
  Invoke-Step -Name "State Publish"        -ScriptPath (Join-Path $ROOT "system\sync\publish_state.ps1")

  Write-Host ""
  Write-Host "============================" -ForegroundColor DarkGray
  Write-Host "  OMEGA MASTER â€” SYSTEM CHECK" -ForegroundColor Cyan
  Write-Host "============================" -ForegroundColor DarkGray
  Write-Host "âœ” Root OK: $ROOT" -ForegroundColor Green
  Write-Host "âœ” Master OK: parsed + executed" -ForegroundColor Green
  Write-Host ""

  if ($ucgOk -and $globalRun -and (Get-Command Stop-UcgRun -ErrorAction SilentlyContinue)) {
    Stop-UcgRun -ROOT $ROOT -RunId $globalRun -Status "ok"
  }

  Write-Host "ðŸ”¥ OMEGA MASTER â€” COMPLETE" -ForegroundColor Magenta
}
catch {
  if ($ucgOk -and (Get-Command Write-UcgEvent -ErrorAction SilentlyContinue)) {
    Write-UcgEvent -ROOT $ROOT -Type "omega.master.error" -Data @{ error=$_.Exception.Message }
  }
  if ($ucgOk -and $globalRun -and (Get-Command Stop-UcgRun -ErrorAction SilentlyContinue)) {
    Stop-UcgRun -ROOT $ROOT -RunId $globalRun -Status "error" -Error $_.Exception.Message
  }
  throw
}