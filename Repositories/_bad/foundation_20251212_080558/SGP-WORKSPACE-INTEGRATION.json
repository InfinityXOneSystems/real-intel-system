{
  "phase": "SGP-WORKSPACE-INTEGRATION",
  "version": "1.0.0",
  "timestamp": "2025-12-03T23:00:00Z",
  "objective": "Enable autonomous Google Workspace integration for deep intelligence ingestion and execution via Service Account 24/7 access",
  "governance_mandates": [
    "Service Account authentication only - no OAuth2 user flows",
    "Non-interactive, persistent 24/7 access to Gmail, Calendar, Docs, Sheets APIs",
    "Autonomous read/write operations for system intelligence and execution",
    "Restricted/sensitive scopes required: gmail.modify, gmail.send, calendar, documents, spreadsheets"
  ],
  "deliverables": [
    {
      "file": "communications/src/gmail_connector.ts",
      "lines": 118,
      "status": "âœ… COMPLETE",
      "purpose": "Autonomous Gmail read/write for email ingestion and system communication",
      "class": "GmailConnector",
      "exports": [
        "constructor()",
        "ingest(query: string) -> Promise<any[]>",
        "send(to, subject, body) -> Promise<GaxiosResponse<GmailV1.Schema$Message>>",
        "markAsProcessed(emailId: string) -> Promise<void>"
      ],
      "scopes": [
        "https://www.googleapis.com/auth/gmail.modify",
        "https://www.googleapis.com/auth/gmail.send"
      ],
      "capabilities": [
        "Query-based email retrieval with Gmail search syntax",
        "Email parsing with header extraction (subject, from, date)",
        "Autonomous email sending with base64 encoding",
        "Email state management (mark as processed)"
      ]
    },
    {
      "file": "communications/src/calendar_connector.ts",
      "lines": 108,
      "status": "âœ… COMPLETE",
      "purpose": "Autonomous calendar management for task scheduling and availability checking",
      "class": "CalendarConnector",
      "exports": [
        "constructor()",
        "scheduleEvent(summary, start, end, attendees) -> Promise<GaxiosResponse<CalendarV3.Schema$Event>>",
        "getFreeBusy(start, end, userEmail) -> Promise<GaxiosResponse<CalendarV3.Schema$FreeBusyResponse>>",
        "getTodayEvents() -> Promise<CalendarV3.Schema$Event[]>"
      ],
      "scopes": [
        "https://www.googleapis.com/auth/calendar"
      ],
      "capabilities": [
        "Create calendar events with attendee notifications",
        "Query free/busy status for scheduling decisions",
        "Daily event retrieval for task prioritization",
        "Timezone-aware scheduling (America/New_York)"
      ]
    },
    {
      "file": "communications/src/docs_connector.ts",
      "lines": 94,
      "status": "âœ… COMPLETE",
      "purpose": "Autonomous document and spreadsheet management for persistent data storage and reporting",
      "class": "DocsConnector",
      "exports": [
        "constructor()",
        "createDoc(title, content) -> Promise<GaxiosResponse<DocsV1.Schema$Document>>",
        "appendSheetRow(spreadsheetId, sheetName, data) -> Promise<GaxiosResponse<SheetsV4.Schema$AppendValuesResponse>>"
      ],
      "scopes": [
        "https://www.googleapis.com/auth/documents",
        "https://www.googleapis.com/auth/spreadsheets"
      ],
      "capabilities": [
        "Create Google Docs with formatted content",
        "Append structured data rows to Google Sheets",
        "Support for metrics logging and audit trails"
      ]
    },
    {
      "file": "communications/src/main.ts",
      "status": "âœ… UPDATED",
      "purpose": "Express.js REST API exposing all Workspace connectors for system integration",
      "new_imports": [
        "GmailConnector",
        "CalendarConnector",
        "DocsConnector"
      ],
      "new_endpoints": {
        "email": {
          "POST /api/v1/email/ingest": {
            "description": "Ingest emails matching query for intelligence extraction",
            "body": { "query": "Gmail search query (default: unread + primary + last 7 days)" },
            "response": { "status": "string", "count": "number", "data": "email[]" }
          }
        },
        "calendar": {
          "POST /api/v1/schedule/new": {
            "description": "Schedule new calendar event with attendee notifications",
            "body": { "summary": "string", "start": "ISO datetime", "end": "ISO datetime", "attendees": "string[]" },
            "response": { "status": "string", "eventId": "string", "link": "string" }
          },
          "GET /api/v1/schedule/today": {
            "description": "Get today's calendar events for task prioritization",
            "response": { "status": "string", "count": "number", "events": "event[]" }
          },
          "POST /api/v1/schedule/availability": {
            "description": "Check free/busy status for scheduling decisions",
            "body": { "start": "ISO datetime", "end": "ISO datetime", "email": "string (optional)" },
            "response": { "status": "string", "availability": "object" }
          }
        },
        "docs_sheets": {
          "POST /api/v1/docs/report": {
            "description": "Write structured report to Google Docs",
            "body": { "title": "string", "content": "string" },
            "response": { "status": "string", "docId": "string", "docUrl": "string" }
          },
          "POST /api/v1/sheets/append": {
            "description": "Append metrics/data row to Google Sheet",
            "body": { "spreadsheetId": "string", "sheetName": "string", "data": "array" },
            "response": { "status": "string", "result": "object" }
          }
        }
      }
    }
  ],
  "authentication_configuration": {
    "method": "Google Service Account",
    "required_environment_variables": [
      "GOOGLE_APPLICATION_CREDENTIALS (path to JSON keyfile) OR",
      "GOOGLE_SERVICE_ACCOUNT_JSON (JSON string)"
    ],
    "key_file_location": "./google-service-account-key.json",
    "service_account_requirements": "Must have delegated access to Gmail, Google Calendar, Google Docs, and Google Sheets APIs"
  },
  "deployment_architecture": {
    "service": "communications",
    "container_port": 3002,
    "environment": "Railway.app",
    "framework": "Express.js + TypeScript",
    "dependencies": [
      "googleapis",
      "express",
      "cors",
      "dotenv"
    ],
    "initialization_sequence": [
      "Load .env configuration",
      "Initialize GmailConnector (sets up Gmail v1 API with Service Account)",
      "Initialize CalendarConnector (sets up Calendar v3 API with Service Account)",
      "Initialize DocsConnector (sets up Docs v1 and Sheets v4 APIs with Service Account)",
      "Register Express middleware (cors, json)",
      "Register health check endpoint",
      "Register root endpoint",
      "Register 6 new Workspace integration endpoints",
      "Register legacy voice endpoints (retained)",
      "Start Express server on port 3002"
    ]
  },
  "execution_readiness": {
    "status": "âœ… READY FOR DEPLOYMENT",
    "commit_hash": "e52555a",
    "files_modified": 1,
    "files_created": 3,
    "total_lines_added": 596,
    "validation_checklist": [
      "âœ… All 3 new connector files created and code-complete",
      "âœ… main.ts updated with 6 new REST endpoints",
      "âœ… Service Account authentication pattern established",
      "âœ… All required Google Workspace APIs integrated",
      "âœ… Error handling implemented across all connectors",
      "âœ… Async/await patterns for all API calls",
      "âœ… Integration with existing microservice architecture verified",
      "âœ… Lint warnings documented (expected for restricted scopes)",
      "âœ… All files committed to git"
    ],
    "deployment_steps": [
      "1. Configure GOOGLE_APPLICATION_CREDENTIALS in Railway environment variables",
      "2. Push master branch to origin (automatically triggers Railway CI/CD)",
      "3. Wait for Docker image build and deployment (~2-5 minutes)",
      "4. Verify communications service health: GET http://communications:3002/health",
      "5. Test email ingestion: POST http://communications:3002/api/v1/email/ingest",
      "6. Test calendar event creation: POST http://communications:3002/api/v1/schedule/new",
      "7. Test report generation: POST http://communications:3002/api/v1/docs/report",
      "8. Activate Vision Subsystem integration for 24/7 autonomous feedback loop"
    ]
  },
  "integration_patterns": {
    "vision_subsystem_feedback_loop": {
      "step_1_ingestion": "Vision Subsystem calls POST /api/v1/email/ingest to retrieve emails",
      "step_2_parsing": "Vision Subsystem analyzes email content for intelligence signals",
      "step_3_strategy": "Strategy layer generates calendar events and reports from intelligence",
      "step_4_execution": "Autonomous execution creates events (POST /api/v1/schedule/new) and logs results (POST /api/v1/sheets/append)",
      "step_5_reporting": "Reports generated to Google Docs (POST /api/v1/docs/report) for human review",
      "cycle_frequency": "24/7 continuous autonomous operation"
    }
  },
  "security_notes": {
    "scope_warnings": "Expected TypeScript lint warnings for restricted (gmail.modify) and sensitive (gmail.send, documents) scopes - these are required for autonomous operation and are not errors",
    "service_account_best_practices": [
      "Never expose Service Account JSON key in source code or logs",
      "Use Railway environment variables for secure credential injection",
      "Rotate Service Account credentials regularly",
      "Monitor API usage via Google Cloud Console for anomalies",
      "Implement rate limiting for high-volume operations"
    ]
  },
  "operational_readiness": {
    "monitoring_recommendations": [
      "Track email ingestion volume and query success rates",
      "Monitor calendar event creation latency",
      "Log Google Docs and Sheets API response times",
      "Alert on authentication failures",
      "Track quota usage against Google Workspace API limits"
    ],
    "failure_modes": [
      "Expired Service Account credentials -> Re-authenticate",
      "Rate limiting exceeded -> Implement exponential backoff",
      "Email query returns no results -> Verify query syntax",
      "Calendar event conflicts -> Check getFreeBusy before scheduling"
    ]
  }
}
