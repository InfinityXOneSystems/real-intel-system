name: Ephemeral Seed Vault (runner)

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  ephemeral-seed:
    runs-on: ubuntu-latest
    name: Ephemeral Vault dev -> create AppRole -> seed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate ephemeral root token and mask it
        id: gen
        run: |
          ROOT_TOKEN=$(openssl rand -hex 32)
          echo "::add-mask::$ROOT_TOKEN"
          echo "ROOT_TOKEN=$ROOT_TOKEN" >> $GITHUB_ENV

      - name: Start Vault dev container
        run: |
          docker run --cap-add=IPC_LOCK -d --name vault-dev -e VAULT_DEV_ROOT_TOKEN_ID=${ROOT_TOKEN} -p 8200:8200 hashicorp/vault:1.14.2 server -dev -dev-root-token-id=${ROOT_TOKEN}

      - name: Wait for Vault to respond
        run: |
          for i in {1..25}; do
            if curl -sSf http://127.0.0.1:8200/v1/sys/health >/dev/null 2>&1; then
              echo 'ready'; exit 0
            fi
            sleep 1
          done
          exit 1

      - name: Decode seed env
        run: |
          echo "${{ secrets.SEED_ENV_B64 }}" | base64 -d > .env.seed

      - name: Create AppRole and save ids (bash)
        shell: bash
        env:
          VAULT_ADDR: http://127.0.0.1:8200
        run: |
          admin=$ROOT_TOKEN
          echo 'Creating migration-writer policy...'
          policy='path "secret/data/migration/users/neoge" { capabilities = ["create","update","read"] }'
          curl -s -X POST -H "X-Vault-Token: $admin" -d "{\"policy\":\"$policy\"}" $VAULT_ADDR/v1/sys/policies/acl/migration-writer >/dev/null

          echo 'Creating AppRole role migration-writer...'
          curl -s -X POST -H "X-Vault-Token: $admin" -d '{"token_policies":"migration-writer","token_ttl":"1h"}' $VAULT_ADDR/v1/auth/approle/role/migration-writer >/dev/null

          role=$(curl -s -H "X-Vault-Token: $admin" $VAULT_ADDR/v1/auth/approle/role/migration-writer/role-id | jq -r .data.role_id)
          secret=$(curl -s -X POST -H "X-Vault-Token: $admin" -d '{}' $VAULT_ADDR/v1/auth/approle/role/migration-writer/secret-id | jq -r .data.secret_id)

          echo "$role" > migration-role-id.txt
          echo "$secret" > migration-secret-id.txt
          echo "::add-mask::$role"
          echo "::add-mask::$secret"
          echo "ROLE_ID=$role" >> $GITHUB_ENV
          echo "SECRET_ID=$secret" >> $GITHUB_ENV

      - name: Seed Vault from .env.seed (bash)
        shell: bash
        env:
          VAULT_ADDR: http://127.0.0.1:8200
        run: |
          # Login using AppRole
          token=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' $VAULT_ADDR/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$token"

          # Build JSON payload from .env.seed
          python3 - <<'PY'
import json
env={}
with open('.env.seed') as fh:
  for line in fh:
    line=line.strip()
    if not line or line.startswith('#'): continue
    if '=' not in line: continue
    k,v=line.split('=',1)
    env[k.strip()]=v.strip()
print(json.dumps({"data":env}))
PY > payload.json

          # Write to KV v2 path 'secret/data/foundation'
          curl -s -X POST -H "X-Vault-Token: $token" -H "Content-Type: application/json" --data @payload.json $VAULT_ADDR/v1/secret/data/foundation | jq -S . | sed -n '1,120p'

      - name: Smoke test readback
        run: |
          token=$(curl -s -X POST -d '{"role_id":"'${ROLE_ID}'","secret_id":"'${SECRET_ID}'"}' http://127.0.0.1:8200/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$token"
          curl -s -H "X-Vault-Token: $token" http://127.0.0.1:8200/v1/secret/data/foundation | jq -S . | sed -n '1,200p'

      - name: Cleanup
        continue-on-error: true
        run: |
          docker rm -f vault-dev || true