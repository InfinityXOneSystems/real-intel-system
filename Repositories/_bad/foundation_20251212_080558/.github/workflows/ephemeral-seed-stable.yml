name: Ephemeral Seed Vault - stable (runner)

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

jobs:
  ephemeral-seed-stable:
    runs-on: ubuntu-latest
    name: Start Vault dev -> enable kv v2 -> create AppRole -> seed -> verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure docker available
        run: |
          docker --version || (echo 'docker missing' && exit 1)

      - name: Debug runner (capture environment)
        run: |
          set -euxo pipefail
          echo "=== runner debug ==="
          uname -a || true
          whoami || true
          date -u || true
          docker --version || true
          echo "SEED_ENV_B64 set: ${SEED_ENV_B64:+yes}" || true
          ls -la || true

      - name: Create root token and start Vault dev
        run: |
          set -euo pipefail
          ROOT=$(openssl rand -hex 32)
          echo "::add-mask::$ROOT"
          docker run --cap-add=IPC_LOCK -d --name vault-stable -e "VAULT_DEV_ROOT_TOKEN_ID=$ROOT" -p 8200:8200 hashicorp/vault:1.14.2 server -dev -dev-root-token-id=$ROOT
          echo "ROOT_TOKEN=$ROOT" >> $GITHUB_ENV

      - name: Wait for Vault healthy
        run: |
          for i in {1..40}; do
            if curl -sSf http://127.0.0.1:8200/v1/sys/health >/dev/null 2>&1; then
              echo ready
              exit 0
            fi
            sleep 1
          done
          echo 'vault did not become healthy' && exit 2

      - name: Enable KV v2 on 'secret'
        run: |
          curl -s -X POST -H "X-Vault-Token: $ROOT_TOKEN" -d '{"type":"kv","options":{"version":"2"}}' http://127.0.0.1:8200/v1/sys/mounts/secret

      - name: Create AppRole (curl)
        run: |
          set -euo pipefail
          ADMIN=$ROOT_TOKEN
          # create policy
          curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{"policy":"path \"secret/data/migration/users/neoge\" { capabilities = [\"create\",\"update\",\"read\"] }"}' http://127.0.0.1:8200/v1/sys/policies/acl/migration-writer
          # create role
          curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{"token_policies":"migration-writer","token_ttl":"1h"}' http://127.0.0.1:8200/v1/auth/approle/role/migration-writer
          ROLE=$(curl -s -H "X-Vault-Token: $ADMIN" http://127.0.0.1:8200/v1/auth/approle/role/migration-writer/role-id | jq -r .data.role_id)
          SECRET_ID=$(curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{}' http://127.0.0.1:8200/v1/auth/approle/role/migration-writer/secret-id | jq -r .data.secret_id)
          if [ -z "$ROLE" ] || [ -z "$SECRET_ID" ]; then echo 'failed to create approle artifacts' && exit 3; fi
          echo "::add-mask::$ROLE"
          echo "::add-mask::$SECRET_ID"
          echo "ROLE_ID=$ROLE" >> $GITHUB_ENV
          echo "SECRET_ID=$SECRET_ID" >> $GITHUB_ENV
          # Save the artifacts so the runner returns them
          echo "$ROLE" > migration-role-id.txt
          echo "$SECRET_ID" > migration-secret-id.txt

      - name: Upload AppRole artifacts
        uses: actions/upload-artifact@v4
        with:
          name: approle-artifacts
          path: |
            migration-role-id.txt
            migration-secret-id.txt

      - name: Decode SEED_ENV_B64
        run: |
          if [ -z "${{ secrets.SEED_ENV_B64 }}" ]; then echo 'SEED_ENV_B64 unset' && exit 1; fi
          echo "${{ secrets.SEED_ENV_B64 }}" | base64 -d > .env.seed

      - name: Build payload.json from .env.seed
        run: |
          python3 - <<'PY' > payload.json
import json
p={}
with open('.env.seed') as f:
  for line in f:
    line=line.strip()
    if not line or line.startswith('#'): continue
    if '=' not in line: continue
    k,v=line.split('=',1)
    p[k.strip()]=v.strip()
print(json.dumps({'data':p}))
PY

      - name: Upload payload artifact
        uses: actions/upload-artifact@v4
        with:
          name: payload-json
          path: payload.json

      - name: Login AppRole & write KV v2
        run: |
          TOKEN=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' http://127.0.0.1:8200/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$TOKEN"
          curl -s -X POST -H "X-Vault-Token: $TOKEN" -H "Content-Type: application/json" --data @payload.json http://127.0.0.1:8200/v1/secret/data/foundation | jq -S . | sed -n '1,40p'

      - name: Verify keys only
        run: |
          TOKEN=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' http://127.0.0.1:8200/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$TOKEN"
          curl -s -H "X-Vault-Token: $TOKEN" http://127.0.0.1:8200/v1/secret/data/foundation | jq -r '.data.data | keys' | sed -n '1,200p'
          echo "TotalKeys=$(curl -s -H \"X-Vault-Token: $TOKEN\" http://127.0.0.1:8200/v1/secret/data/foundation | jq -r '.data.data | keys | length')"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f vault-stable || true