name: Ephemeral Vault Seed Test
on:
  push:
    branches:
      - master

jobs:
  seed-vault:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl unzip openssl jq

      - name: Download and run Vault (binary)
        run: |
          set -euo pipefail
          VAULT_VER=1.14.2
          curl -sSLo vault.zip https://releases.hashicorp.com/vault/${VAULT_VER}/vault_${VAULT_VER}_linux_amd64.zip
          unzip -o vault.zip -d .
          ./vault version
          ROOT=$(openssl rand -hex 32)
          echo "::add-mask::$ROOT"
          ./vault server -dev -dev-root-token-id=$ROOT -dev-listen-address=127.0.0.1:8200 &
          VAULT_PID=$!
          echo "VAULT_ADDR=http://127.0.0.1:8200" >> $GITHUB_ENV
          echo "ROOT_TOKEN=$ROOT" >> $GITHUB_ENV
          for i in {1..40}; do
            if curl -sSf http://127.0.0.1:8200/v1/sys/health >/dev/null 2>&1; then
              echo "ready"
              exit 0
            fi
            sleep 1
          done
          exit 1

      - name: Setup AppRole auth + policy
        run: |
          set -euo pipefail
          ADMIN="$ROOT_TOKEN"
          
          curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{"type":"approle"}' http://127.0.0.1:8200/v1/sys/auth/approle >/dev/null 2>&1 || true
          
          curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{"policy":"path \"secret/data/foundation\" { capabilities = [\"create\",\"update\",\"read\",\"list\"] }"}' http://127.0.0.1:8200/v1/sys/policies/acl/seed-writer >/dev/null 2>&1
          
          curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{"token_policies":"seed-writer","token_ttl":"24h"}' http://127.0.0.1:8200/v1/auth/approle/role/seed-bot >/dev/null 2>&1
          
          ROLE_ID=$(curl -s -H "X-Vault-Token: $ADMIN" http://127.0.0.1:8200/v1/auth/approle/role/seed-bot/role-id | jq -r .data.role_id)
          SECRET_ID=$(curl -s -X POST -H "X-Vault-Token: $ADMIN" -d '{}' http://127.0.0.1:8200/v1/auth/approle/role/seed-bot/secret-id | jq -r .data.secret_id)
          
          if [ -z "$ROLE_ID" ] || [ -z "$SECRET_ID" ]; then
            echo 'ERROR: Failed to create AppRole credentials'
            exit 3
          fi
          
          echo "::add-mask::$ROLE_ID"
          echo "::add-mask::$SECRET_ID"
          echo "$ROLE_ID" > seed-role-id.txt
          echo "$SECRET_ID" > seed-secret-id.txt

      - name: Decode seed environment and write to Vault
        run: |
          set -euo pipefail
          
          # Decode SEED_ENV_B64
          if [ -z "${{ secrets.SEED_ENV_B64 }}" ]; then
            echo "ERROR: SEED_ENV_B64 secret not configured"
            exit 1
          fi
          
          SEED_ENV=$(echo -n "${{ secrets.SEED_ENV_B64 }}" | base64 -d)
          echo "Decoded seed environment (first 100 chars): ${SEED_ENV:0:100}..."
          
          # Convert env format (KEY=value) to JSON {"KEY": "value"}
          PAYLOAD_JSON=$(echo "$SEED_ENV" | jq -sR 'split("\n") | map(select(length > 0) | split("=") | {(.[0]): (.[1:] | join("="))}) | add' || echo '{}')
          
          # Get AppRole credentials
          ROLE_ID=$(cat seed-role-id.txt)
          SECRET_ID=$(cat seed-secret-id.txt)
          
          # Login to Vault
          TOKEN=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' http://127.0.0.1:8200/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$TOKEN"
          
          # Write payload to Vault
          curl -s -X POST -H "X-Vault-Token: $TOKEN" -H "Content-Type: application/json" -d "{\"data\": $PAYLOAD_JSON}" http://127.0.0.1:8200/v1/secret/data/foundation | jq .

      - name: Verify seed was written
        run: |
          set -euo pipefail
          
          ROLE_ID=$(cat seed-role-id.txt)
          SECRET_ID=$(cat seed-secret-id.txt)
          
          TOKEN=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' http://127.0.0.1:8200/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$TOKEN"
          
          RESPONSE=$(curl -s -H "X-Vault-Token: $TOKEN" http://127.0.0.1:8200/v1/secret/data/foundation)
          KEYS=$(echo "$RESPONSE" | jq '.data.data | keys | length')
          
          echo "Total keys in seed: $KEYS"
          echo "$RESPONSE" | jq '.data.data | keys[]' | head -20

      - name: Cleanup
        if: always()
        run: |
          pkill vault || true
          rm -f vault vault.zip seed-role-id.txt seed-secret-id.txt || true
