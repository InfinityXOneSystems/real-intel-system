name: Ephemeral Seed Vault (v2) - dev runner

on:
  workflow_dispatch:

jobs:
  ephemeral-seed-v2:
    runs-on: ubuntu-latest
    name: Start Vault dev, enable kv v2, create approle, seed, verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate root token and mask
        run: |
          ROOT_TOKEN=$(openssl rand -hex 32)
          echo "::add-mask::$ROOT_TOKEN"
          echo "ROOT_TOKEN=$ROOT_TOKEN" >> $GITHUB_ENV

      - name: Start Vault dev
        run: |
          docker run --cap-add=IPC_LOCK -d --name vault-dev-v2 -e VAULT_DEV_ROOT_TOKEN_ID=${ROOT_TOKEN} -p 8200:8200 hashicorp/vault:1.14.2 server -dev -dev-root-token-id=${ROOT_TOKEN}

      - name: Wait
        run: |
          for i in {1..30}; do
            if curl -sSf http://127.0.0.1:8200/v1/sys/health >/dev/null 2>&1; then
              echo ready; exit 0
            fi
            sleep 1
          done
          exit 1

      - name: Enable KV v2 at secret
        run: |
          curl -s -X POST -H "X-Vault-Token: $ROOT_TOKEN" -d '{"type":"kv","options":{"version":"2"}}' http://127.0.0.1:8200/v1/sys/mounts/secret

      - name: Create migration AppRole (bash)
        shell: bash
        env:
          VAULT_ADDR: http://127.0.0.1:8200
        run: |
          admin=$ROOT_TOKEN
          curl -s -X POST -H "X-Vault-Token: $admin" -d '{"policy":"path \"secret/data/migration/users/neoge\" { capabilities = [\"create\",\"update\",\"read\"] }"}' $VAULT_ADDR/v1/sys/policies/acl/migration-writer >/dev/null
          curl -s -X POST -H "X-Vault-Token: $admin" -d '{"token_policies":"migration-writer","token_ttl":"1h"}' $VAULT_ADDR/v1/auth/approle/role/migration-writer >/dev/null
          role=$(curl -s -H "X-Vault-Token: $admin" $VAULT_ADDR/v1/auth/approle/role/migration-writer/role-id | jq -r .data.role_id)
          secret=$(curl -s -X POST -H "X-Vault-Token: $admin" -d '{}' $VAULT_ADDR/v1/auth/approle/role/migration-writer/secret-id | jq -r .data.secret_id)
          echo "::add-mask::$role"
          echo "::add-mask::$secret"
          echo "$role" > migration-role-id.txt
          echo "$secret" > migration-secret-id.txt
          echo "ROLE_ID=$role" >> $GITHUB_ENV
          echo "SECRET_ID=$secret" >> $GITHUB_ENV

      - name: Decode seed env
        run: |
          echo "${{ secrets.SEED_ENV_B64 }}" | base64 -d > .env.seed

      - name: Seed vault (bash)
        shell: bash
        env:
          VAULT_ADDR: http://127.0.0.1:8200
        run: |
          token=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' $VAULT_ADDR/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$token"
          python3 - <<'PY' > payload.json
import json
env={}
with open('.env.seed') as fh:
  for line in fh:
    line=line.strip()
    if not line or line.startswith('#'): continue
    if '=' not in line: continue
    k,v=line.split('=',1)
    env[k.strip()]=v.strip()
print(json.dumps({'data': env}))
PY
          curl -s -X POST -H "X-Vault-Token: $token" -H "Content-Type: application/json" --data @payload.json $VAULT_ADDR/v1/secret/data/foundation | jq -S . | sed -n '1,200p'

      - name: Verify
        run: |
          token=$(curl -s -X POST -d '{"role_id":"'$ROLE_ID'","secret_id":"'$SECRET_ID'"}' http://127.0.0.1:8200/v1/auth/approle/login | jq -r '.auth.client_token')
          echo "::add-mask::$token"
          curl -s -H "X-Vault-Token: $token" http://127.0.0.1:8200/v1/secret/data/foundation | jq -S . | sed -n '1,200p'

      - name: Cleanup
        continue-on-error: true
        run: |
          docker rm -f vault-dev-v2 || true